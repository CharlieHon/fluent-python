# 第14张 可迭代的对象、迭代器和生成器

迭代是数据处理的基石。扫描内存中放不下的数据集时，要找到一种惰性获取数据项的方式，即按需一次获取一个数据项。这就是迭代器模式(Iterator pattern)。

`yield`关键字用于构建生成器(generator)，其作用与迭代器一样。所有生成器都是迭代器，因为生成器完全实现了迭代器接口。

在Python中，所有集合都可以迭代。在Python语言内部，迭代器用于支持：

- `for`循环
- 构建和扩展集合类型
- 逐行遍历文本文件
- 列表推导、字典推导和集合推导
- 元组拆包
- 调用函数时，使用`*`拆包实参

本章涵盖以下主题：

- 语言内部使用`iter()`内置函数处理可迭代对象的方式
- 如何使用Python实现经典的迭代器模式
- 详细说明生成器函数的工作原理
- 如何使用生成器函数或生成器表达式代替经典的迭代器
- 如何使用标准库中通用的生成器函数
- 如何使用`yield from`语句合并生成器
- 案例分析：在一个数据库转换工具中使用生成器函数处理大型数据集
- 为什么生成器和写成看似相同，实则差别很大，不能混淆

## 序列可以迭代的原因：iter函数

[Sentence类第1版](02_Sentence_v1_单词序列.py)

解释器需要对象`x`时，会自动调用iter(x)。

内置的`iter`函数有以下作用：

1. 检查对象是否实现了 `__iter__` 方法，如果实现了它就调用它，获取一个迭代器。
2. 如果没有实现 `__iter__` 方法，但是实现了 `__getitem__` 方法，Python会创建一个迭代器，尝试按顺序(从索引0开始)获取元素。
3. 如果尝试失败，Python会抛出 `TypeError` 异常，通常会提示`C object is not iterable` ，其中C是目标所属的类，

任何Python序列都可迭代的原因是，它们都实现了 `__getitem__` 方法。

鸭子类型(duck typing)的极端形式：不仅要实现特殊的 `__iter__` 方法，还要实现 `__getitem__` 方法，而且 `__getitem__` 方法的参数是从0开始的整数这样才认为对象是可迭代的。

在白鹅类型(goose-typing)可迭代对象定义简单些：如果实现了 `__iter__` 方法，那么就认为对象是可迭代的。

```python
class Foo:
    def __iter__(self):
        pass

from collections import abc
print(issubclass(Foo, abc.Iterable))    # True

f = Foo()
print(isinstance(f, abs.Iterable))    # True
```

检查对象 `x` 能否迭代，最准确的方法是：调用 iter(x) 函数，如果不可迭代，再处理 TypeError 异常。
